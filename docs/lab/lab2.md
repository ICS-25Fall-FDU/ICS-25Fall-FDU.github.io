# Lab2: BombLab

> Deadline：2025-10-28

## 1 实验概述

本实验为 CSAPP 第三章配套实验。

这是一款全新的代码世界冒险游戏；相比 csapp 的经典款BombLab，它更加易玩。你将作为一位精通汇编语言/ linux / gdb / 数据结构的幸存者，在一座即将走向末路的“AI城市”中，通过自己的智慧与胆量发现隐藏在混乱的 x86 汇编背后的真相......

- 二进制炸弹（bomb）是一个可执行文件，包含若干关卡
- 输入正确的口令，可以通过一个关卡；各关卡口令互不相同
- 口令错误，炸弹就会爆炸 o(TヘTo)
- 实验的目标是拆弹成功，也就是无伤通过所有关卡

- **你的核心目标**：拆除二进制炸弹`bomb++` 

---



## 2 实验组成

### 2.1 互动式gdb教程

> 注：本部分仅起到让大家快速上手gdb的教学作用。不占分，也不要求必须完成。

教程位于`./gdb-tutor`目录下。

- **`gdb-tutor`**：一个旨在帮助各位学习和练习使用 GDB 的可执行文件。侧重于实验所需的调试技巧。
- **`gdb-tutor.c`**：与 `gdb-tutor` 可执行文件对应的源代码。可以选择边阅读改.c源码中的文字和提示，边在终端与可执行文件交互。

**使用方法：** 直接在`./src/gdb-tutor`目录下执行命令：

```shell
 ./gdb-tutor
```

### 2.2 实验主体：二进制炸弹`bomb++`

实验主体位于`./bomb`目录下

`bomb++`是一个包含多个关卡的可执行文件，由六个阶段组成。**其核心机制为：输入正确口令→通过关卡；错误口令→炸弹爆炸。** 

你的目标是使用各种分析手段，找到每个关卡对应的通关口令并运行bomb++输入它们，尽可能多地拆除阶段直至无伤通关。

#### 其他实验文件

+ **`main.cpp`**:
  - 实验主程序的源代码。由于*敌人*没收了炸弹的具体实现方法，故单独的main.cpp并不能直接运行；但你可以阅读main.cpp大致获取本实验代码的整体流程，或许能够为拆除炸弹提供一些帮助。

---



## 3 实验前准备

### 3.1 环境配置

#### 从GitHub Classroom拉取实验仓库

推荐使用ssh方式克隆仓库（想必你已经熟悉这一点）。

```shell
git clone git@github.com:ICS-25Fall-FDU/lab2-bomblab-xxx.git # 将xxx替换为自己的用户名
cd lab2-bomblab-xxx
```

#### 安装和配置GDB



在Ubuntu中安装gdb非常简单: 

```shell
# 更新软件包列表
sudo apt update

# 安装gdb
sudo apt install gdb
```

#### 按需安装pwndbg插件



#### 设置汇编语言风格（Intel/AT&T）

在 CSAPP 课本上，有一个拓展框介绍了两种汇编语言的格式—— AT&T 以及 Intel。

他们最显著的区别有两个（当然还有别的区别，见课本）：

- **两者的源操作数和目的操作数顺序相反**（这可能会极大影响你对汇编代码的阅读，所以务必注意你在使用何种顺序习惯的语言）
- AT&T 中寄存器需要加上 `%` 前缀，而 Intel 语法则不用。

本课程上课教学时使用的语法是 AT&T，这也是 objdump 默认使用的语法。但如果你~~并不想看一堆%~~ 想试试 Intel 语法那也十分推荐，因为这是安全研究人员更常用的一种语法。想让 objdump 输出语法变为 Intel，只需要给 objdump 添加参数 `-M intel`。

### 3.2 配置文件设置

`config.txt`是本次实验的配置文件，包含以下几个配置项：

1. **配置学号**

   本次 BombLab 采用了个性化答案制度，即*每个人的答案会依据自己的学号发生变化*。因此，**请务在`config.txt`中填写自己的学号！** 

> [!warning]
>
> 助教会根据每个人的学号来判断答案；**漏填学号或者填错学号导致的错误助教概不负责。**

2. **设置测试关卡：**`test_phase = 1,2,3,4,5,6` 

   通过修改test_phase的值，可以实现跳关。该功能能够完美适应某个phase做不下去或希望单独测试某phase的情况。记得按需使用。

3. **剧情模式开关**

   > 剧情模式是为了增加做实验过程中的乐趣所设，我们真心希望大家写 Lab 时能乐在其中！当然，如果你觉得剧情模式的大段输出影响到了你正常解题，可以在 `config.txt` 中随时将其关闭。

   关闭剧情模式：`story_mode = false`

   开启剧情模式：`story_mode = true` 

   > 请确保在提交时，`config.txt` 中，`story_mode` 被设置为 `false`。

---



## 4 拆弹指导

### 4.1 什么是"拆炸弹"？

拆炸弹，简单来说就是找到程序要求的所有正确输入。如前文所述，我们需要运行`bomb++`，分析`bomb++`程序的汇编代码，找出每个关卡的正确输入口令，避免程序爆炸退出。

通过每一关后都会有通关提示（并输出一段剧情）；如果炸弹爆炸，它将会输出 `BOOM!!!` 并退出。

#### 结局

本次实验有三种结局，分别是：（详见 `main.cpp`）

- **BE**（Bomb Ending，即炸弹爆炸，拆弹失败）~~（并非Bad Ending）~~

  > 炸弹会读取 `fail.txt` 并在爆炸时打印其内容，如果你想要很酷炫的爆炸，可以自行修改 `fail.txt` 或直接将其删去。

- **NE**（Normal Ending，即成功解出6个phase的口令，拆除炸弹）

- **TE**（True Ending，需要你在NE的基础上继续探索......）

#### 关卡提示

实验各个关卡涉及的知识大致如下：

1. 函数调用
2. 循环
3. 分支
4. 递归
5. 面向对象
6. 单调栈

Secret. ████

请注意，Secret 的解锁条件在第三关中进行了提示，或许你能在 `main.cpp` 的某个函数中发现一些违和之处…

如果执行立即结束并且没有任何反馈，则没有问题。

> [!tip]
>
> 在解决每一个关卡时，将该关卡对应涉及的知识牢记于心或许会事半功倍。因此强烈推荐常回来查看上面的关卡提示。



### 4.2 如何上手拆弹？

本拆弹实验本质上是一道**逆向工程**题，它需要你在没有源代码的情况下复原程序编写者的意图与程序的逻辑。在逆向工程中，分析方法可以大致归类为两类：动态分析与静态分析。

简单来说，动态分析就是运行程序，在程序运行的过程中（使用gdb等工具）逐步观察其行为；静态分析就是借助可执行文件中的信息与数据（如机器码），人肉还原程序逻辑。

在本实验中，我们会分别介绍动态分析、静态分析的方法与工具，然后再介绍一些别的小工具。

#### 动态分析（使用GDB）

最简单的动态分析就是直接运行程序。你可以不妨先试试引爆炸弹找找感觉。

正经的动态分析就是使用 `gdb`（全称为 GNU Debugger）等调试工具进行动态调试。动态调试的坏处是可能会一不小心让程序“跑飞了”，即不小心错过你想要观察的代码片段；而好处就很明显了：你可以在程序运行时实时观察其运行状态和各种数据的实际值。

**为了避免“跑飞”，在合适的函数名或具体地址处设置断点就变得至关重要。** 在此仍然推荐参考 `gdb-tutor`。



你可以去网上找一个 gdb cheetsheet（小抄），方便你查找想用的指令。我们也给出一个挺好的英文教程：[Tudor‘s gdb crash course](https://users.umiacs.umd.edu/~tdumitra/courses/ENEE757/Fall15/misc/gdb_tutorial.html)。或者可以直接在 Linux 环境下 `man gdb`（man 为 manual 的缩写，是用来查看系统命令和程序的手册页的命令）查看 gdb 的完整文档。

以下为一些 gdb 的常用指令：

| 命令（缩写）   | 作用                                                   | 示例              |
| -------------- | ------------------------------------------------------ | ----------------- |
| tab            | 命令或关键字补全                                       |                   |
| run (r)        | 运行程序                                               | r                 |
| quit (q)       | 退出 gdb                                               | q                 |
| break (b)      | 打断点，可指定函数名或具体地址                         | b *0x400540       |
| continue (c)   | 继续运行程序，一般是从断点处开始                       | c                 |
| print (p)      | 打印数据，可以指定格式，也可以指定寄存器、内存、变量等 | p /x *($rsp+8)    |
| display (disp) | 指定的内容和print一样，不过可以重复展示                | display /5i $pc   |
| info (i)       | 获取信息，可指定寄存器、函数、断点信息等               | i r{egister} pc   |
| delete         | 删除gdb指定的内容，可指定断点等（默认是断点）          | d {break} 1       |
| stepi (si)     | 执行一条指令，后可跟数字表示执行多条                   | si 10             |
| examine (x)    | 代码检查，后跟具体地址，可以指定输出的方式和格式       | x /10i $pc        |
| call           | 在gdb中进行函数调用（很神奇的功能）                    | call printf("\n") |
| backtrace (bt) | 查看调用栈，即函数调用的情况                           | bt                |

如果你还想用pwndbg，也可以自行查阅其用法。pwndbg的用法会比gdb稍微丰富一些，能够直接展示的关键信息也更加复杂，请按需查阅资料使用。

#### 静态分析（反汇编）

- **工具**：objdump反汇编器

- **命令示例**：

  ```bash
  objdump -d -M intel --disassemble=phase_1 bomb++ > phase_1.S
  ```

- **技巧**：使用`-M intel`参数获得Intel格式汇编代码









---



## 5 其他

### 5.2 效率技巧

- **重定向输入**：将口令保存到`password.txt`，使用：

  ```bash
  ./bomb++ < password.txt
  ```

- **管道调试**：组合已知口令和实时输入：

  ```bash
  cat known_passwords.txt - | ./bomb++
  ```



## 8. 提交要求

### 8.1 必须文件

- `password.txt`：
  - 所有关卡的正确口令
  - 将`story_mode`设置为`false`
- `lab2_学号_姓名.pdf`：实验报告（PDF格式）
- `config.txt`：正确配置的配置文件

### 8.2 实验报告内容

你的实验报告应包含以下内容：

1. 姓名和学号
2. 每个关卡的推演过程（重点），如你如何推测函数的功能
3. 拆弹成功的截图（请关闭剧情模式进行截图）
4. 如果有，请列出引用的内容以及参考的资料
5. 对助教和实验的意见或建议（可选）

### 8.3 提交

打开终端，执行以下指令：

```shell
# 在以下文件的根目录下添加以下三个内容到暂存区
# 如果无法成功添加，请检查终端中的当前目录和以下文件路径是否对应
git add password.txt lab2_<学号>.pdf config.txt

# 将暂存区的所有更改提交到本地仓库
git commit -m "xxx(你的提交注释)"

# 对最后一个 commit，请添加 tag: final
git tag "final"

# 请务必将本地仓库推送到远程
git push
```

### 8.4 评分标准

| 项目                              | 分值 |
| --------------------------------- | ---- |
| 提交格式正确，内容完整            | 1    |
| 通过正常关卡 6\*14                | 84   |
| 实验报告                          | 15   |
| **bonus：** 打出TE（True Ending） | +10  |

另：抄袭倒扣分！！勿谓言之不预。

> **反卷斗士の承诺：**
>
> 实验过程非抄袭的同学，实验报告部分赋满分。一旦发现抄袭，则零分处理。

#### 关于迟交





## 参考资料

- 原版 Lab：<http://csapp.cs.cmu.edu/3e/labs.html> 
- 本实验参考 22、23、24年的实验开发



> 负责助教：马颢宸 罗贤可昕





